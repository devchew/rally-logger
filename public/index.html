<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>JS Bin</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://unpkg.com/gps@0.6.1/gps.min.js" crossorigin=""></script>
    <style>
        html,
        body {
            margin: 0;
            paddding: 0;
            height: 100%;
            width: 100%;
        }

        .setting {
            position: fixed;
            top: 0;
            left: 100px;
            z-index: 100;
            background-color: #fff;
        }

        #map {
            height: 100vh;
            z-index: 0;
        }
    </style>
</head>

<body>

    <div id="map"></div>

    <fieldset class="setting">
        <form id="loadForm">
            <label>id</label>
            <input type=number name="id" />
            <button type="submit">wczytaj</button>
        </form>
    </fieldset>



    <script>

        var map = L.map('map').setView([51.505, -0.09], 13);

        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);



        const visualize = (parsed) => {
            
            var latlngs = parsed.filter(Boolean).filter(v => v.lon && v.valid).map(cords => [cords.lat, cords.lon])

            var polyline = L.polyline(latlngs, { color: 'red' }).addTo(map);

            map.fitBounds(polyline.getBounds());
        }
        const loadfile = (event) => {
            event.preventDefault();
            const formData = new FormData(event.target);
            const id = formData.get("id");

            Promise.all(new Array(200).fill(null).map((_, i) => fetch(`/gps/${i}.nmea`).then(r => r.text())))
                .then(v => v.join(""))
                .then(d => {
                    console.log(d);
                    return d;
                })
                .then(lines => lines.split('\n'))
                .then(lines => lines.filter(l => l.startsWith('$')).map(line => {
                    try {
                        return GPS.Parse(line)
                    } catch (error) {
                        return;
                    }
                }))
                .then(visualize)

        }

        document.querySelector("#loadForm").addEventListener("submit", loadfile)

    </script>
</body>

</html>